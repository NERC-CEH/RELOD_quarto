<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>RELOD ebook - 3&nbsp; LiDAR data processing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./sentinel1.html" rel="next">
<link href="./gedi_exploration.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./lidar_processing.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">LiDAR data processing</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">RELOD ebook</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gedi_processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">GEDI data processing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gedi_exploration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">GEDI data exploration</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lidar_processing.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">LiDAR data processing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sentinel1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Sentinel 1 SAR time-lapse image</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sh_RS_comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Strawberry Hill analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#pre-processing-steps" id="toc-pre-processing-steps" class="nav-link active" data-scroll-target="#pre-processing-steps"><span class="header-section-number">3.1</span> Pre-processing steps</a>
  <ul class="collapse">
  <li><a href="#thinning-and-filtering" id="toc-thinning-and-filtering" class="nav-link" data-scroll-target="#thinning-and-filtering"><span class="header-section-number">3.1.1</span> Thinning and filtering:</a></li>
  <li><a href="#retiling" id="toc-retiling" class="nav-link" data-scroll-target="#retiling"><span class="header-section-number">3.1.2</span> Retiling:</a></li>
  <li><a href="#classifying-the-ground" id="toc-classifying-the-ground" class="nav-link" data-scroll-target="#classifying-the-ground"><span class="header-section-number">3.1.3</span> Classifying the ground</a></li>
  </ul></li>
  <li><a href="#the-digital-terrain-model" id="toc-the-digital-terrain-model" class="nav-link" data-scroll-target="#the-digital-terrain-model"><span class="header-section-number">3.2</span> The digital terrain model:</a></li>
  <li><a href="#classification-term" id="toc-classification-term" class="nav-link" data-scroll-target="#classification-term"><span class="header-section-number">3.3</span> Classification term</a></li>
  <li><a href="#digital-surface-model-and-canopy-height-model" id="toc-digital-surface-model-and-canopy-height-model" class="nav-link" data-scroll-target="#digital-surface-model-and-canopy-height-model"><span class="header-section-number">3.4</span> DIGITAL SURFACE MODEL and canopy height model:</a></li>
  <li><a href="#locating-trees" id="toc-locating-trees" class="nav-link" data-scroll-target="#locating-trees"><span class="header-section-number">3.5</span> Locating trees:</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">LiDAR data processing</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">echo =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#library(doMC)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(renv)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RCurl)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(devtools)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lidR)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster) <span class="co"># These functions rely on the raster package which is being superceded by terra</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># terra isn't compatable with all other packages used here though, so raster is still needed</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearthdata)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel) <span class="co"># for parallel computing</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapview)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lidR)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rayshader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in rgl.init(initValue, onlyNULL): RGL: unable to open X11 display</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 'rgl.init' failed, running with 'rgl.useNULL = TRUE'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># you set this for when you want things to be computed in parallel</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#detectCores() # I have 4 cores, so will use 3 for the computation here:</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># see https://rdrr.io/cran/lidR/man/lidR-parallelism.html</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> <span class="dv">3</span>L)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in checkNumberOfLocalWorkers(workers): Careful, you are setting up 3
localhost parallel workers with only 2 CPU cores available for this R process
(per 'cgroups.cpuquota'), which could result in a 150% load. The soft limit is
set to 100%. Overusing the CPUs has negative impact on the current R process,
but also on all other processes of yours and others running on the same
machine. See help("parallelly.options", package = "parallelly") for how to
override the soft and hard limits</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>())</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># creating a world map for plotting</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale=</span><span class="st">"medium"</span>, <span class="at">returnclass=</span><span class="st">"sf"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>world <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(world, <span class="at">coords=</span><span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>), <span class="at">crs =</span> <span class="dv">27700</span>, <span class="at">agr =</span> <span class="st">"constant"</span>, <span class="at">remove =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="pre-processing-steps" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="pre-processing-steps"><span class="header-section-number">3.1</span> Pre-processing steps</h2>
<p>This R script takes a pre-processed point cloud from a UAV drone pass file .laz or .las. It reads the files in using the LAStools package, which is a separate executable programme which can be implemented through R. .laz files are zipped versions of .las files. They can be good for storing large amounts of data, however they do take time to unzip each time you use them so are not always better than .las files for storing drone data.</p>
<p>A really useful place to start is the lidR package which has detailed tutorials: lidR book: https://r-lidar.github.io/lidRbook/index.html This lays out a lot of the preprocessing steps:</p>
<p>readLAS(filter = “-help”)</p>
<p>can thin the dataset before you read it filter = “xyz” removes all but the point cloud data filter = “-keep_first” : commonly used in forestry filter = “-keep_every_nth x” used for thinning out the point cloud to reduce the size</p>
<section id="thinning-and-filtering" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="thinning-and-filtering"><span class="header-section-number">3.1.1</span> Thinning and filtering:</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load a LAScatalog instead of a LAS file</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="do">## try reading the full las file and thin it:</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># this is a big file and it does take a while to load even when thinned</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># try thin_with_grid</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>las_first <span class="ot">&lt;-</span> <span class="fu">readLAS</span>(<span class="fu">here</span>(<span class="st">"data-raw"</span>, <span class="st">"lidar"</span>, <span class="st">"Knepp_points_processed_merged.las"</span>),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">filter =</span> <span class="st">"-keep_first"</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLAS</span>(las_first, <span class="fu">here</span>(<span class="st">"data-raw"</span>, <span class="st">"lidar"</span>, <span class="st">"knepp_full_keep_first.las"</span>))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure you have the most up to date version of lidR</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># this is one every 20cm - this is still very high resolution and probably enough for processing</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>las_100th <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">readLAS</span>(<span class="fu">here</span>(<span class="st">"data-raw"</span>, <span class="st">"lidar"</span> <span class="st">"Knepp_points_processed_merged.las"</span>), </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">filter =</span> <span class="st">"-keep_every_nth 100"</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLAS</span>(las_100th, <span class="fu">here</span>(<span class="st">"data-output"</span>, <span class="st">"lidar_outputs"</span>, <span class="st">"knepp_full_thin_100.las"</span>))</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>las_10th <span class="ot">&lt;-</span> <span class="fu">readLAS</span>(<span class="fu">here</span>(<span class="st">"data-raw"</span>, <span class="st">"lidar"</span>, <span class="st">"Knepp_points_processed_merged.las"</span>),</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">filter =</span> <span class="st">"-keep_every_nth 10"</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLAS</span>(las_10th, <span class="fu">here</span>(<span class="st">"data-raw"</span>, <span class="st">"lidar"</span>, <span class="st">"knepp_full_thin_10.las"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="retiling" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="retiling"><span class="header-section-number">3.1.2</span> Retiling:</h3>
<p>Splitting into smaller tiles for ease of processing</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ctg <span class="ot">&lt;-</span> <span class="fu">readLAScatalog</span>(<span class="fu">here</span>(<span class="st">"data-output"</span>, <span class="st">"lidar_outputs"</span>, <span class="st">"knepp_full_thin_100.las"</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">opt_chunk_buffer</span>(ctg) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">opt_chunk_size</span>(ctg) <span class="ot">&lt;-</span> <span class="dv">250</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">opt_output_files</span>(ctg) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data-output/lidar_outputs/las_cat_10"</span>, <span class="st">"/retile_{XLEFT}_{YBOTTOM}"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ctg, <span class="at">chunk =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">catalog_retile</span>(ctg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Loading in our .las file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Process it like a LAS file</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>ctg <span class="ot">&lt;-</span> <span class="fu">readLAScatalog</span>(<span class="fu">here</span>(<span class="st">"data-output/lidar_outputs/las_cat_100"</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>las <span class="ot">&lt;-</span> <span class="fu">readLAS</span>(ctg,<span class="at">filter =</span> <span class="st">"-drop_z_below 0"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">#plot(las)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="classifying-the-ground" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="classifying-the-ground"><span class="header-section-number">3.1.3</span> Classifying the ground</h3>
<p>I think this had already been done in the original knepp point cloud. So this is redoing that as it isn’t always accurate. It includes pmf, csf and mcc for ground classification. ws = Sequence of windows sizes to be used in filtering ground returns. The values must be positive and in the same units as the point cloud (usually meters, occasionally feet).</p>
<p>th = numeric. Sequence of threshold heights above the parameterized ground surface to be considered a ground return. The values must be positive and in the same units as the point cloud. Values used here as in “Estimating Forest Structure from UAV-Mounted LiDAR Point Cloud Using Machine Learning”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this is time consuming</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#ws &lt;- seq(0.5, 2.5, 3)</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#th &lt;- seq(0.1,0.5, length.out = length(ws))</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># this function extracts some default ws and th values to use from </span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the Zhang paper</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">util_makeZhangParam</span>(</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="dv">2</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">dh0 =</span> <span class="fl">0.5</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">dhmax =</span> <span class="dv">3</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">s =</span> <span class="dv">1</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_ws =</span> <span class="dv">20</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">exp =</span> <span class="cn">FALSE</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>las <span class="ot">&lt;-</span> <span class="fu">classify_ground</span>(las, <span class="at">algorithm =</span> <span class="fu">pmf</span>(<span class="at">ws =</span> p<span class="sc">$</span>ws, <span class="at">th =</span> p<span class="sc">$</span>th))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Morphological filter: 4% (1 threads)
Morphological filter: 5% (1 threads)
Morphological filter: 6% (1 threads)
Morphological filter: 7% (1 threads)
Morphological filter: 8% (1 threads)
Morphological filter: 9% (1 threads)
Morphological filter: 10% (1 threads)
Morphological filter: 11% (1 threads)
Morphological filter: 12% (1 threads)
Morphological filter: 13% (1 threads)
Morphological filter: 14% (1 threads)
Morphological filter: 15% (1 threads)
Morphological filter: 16% (1 threads)
Morphological filter: 17% (1 threads)
Morphological filter: 18% (1 threads)
Morphological filter: 19% (1 threads)
Morphological filter: 20% (1 threads)
Morphological filter: 21% (1 threads)
Morphological filter: 22% (1 threads)
Morphological filter: 23% (1 threads)
Morphological filter: 24% (1 threads)
Morphological filter: 25% (1 threads)
Morphological filter: 26% (1 threads)
Morphological filter: 27% (1 threads)
Morphological filter: 28% (1 threads)
Morphological filter: 29% (1 threads)
Morphological filter: 30% (1 threads)
Morphological filter: 31% (1 threads)
Morphological filter: 32% (1 threads)
Morphological filter: 33% (1 threads)
Morphological filter: 34% (1 threads)
Morphological filter: 35% (1 threads)
Morphological filter: 36% (1 threads)
Morphological filter: 37% (1 threads)
Morphological filter: 38% (1 threads)
Morphological filter: 39% (1 threads)
Morphological filter: 40% (1 threads)
Morphological filter: 41% (1 threads)
Morphological filter: 42% (1 threads)
Morphological filter: 43% (1 threads)
Morphological filter: 44% (1 threads)
Morphological filter: 45% (1 threads)
Morphological filter: 46% (1 threads)
Morphological filter: 47% (1 threads)
Morphological filter: 48% (1 threads)
Morphological filter: 49% (1 threads)
Morphological filter: 50% (1 threads)
Morphological filter: 51% (1 threads)
Morphological filter: 52% (1 threads)
Morphological filter: 53% (1 threads)
Morphological filter: 54% (1 threads)
Morphological filter: 55% (1 threads)
Morphological filter: 56% (1 threads)
Morphological filter: 57% (1 threads)
Morphological filter: 58% (1 threads)
Morphological filter: 59% (1 threads)
Morphological filter: 60% (1 threads)
Morphological filter: 61% (1 threads)
Morphological filter: 62% (1 threads)
Morphological filter: 63% (1 threads)
Morphological filter: 64% (1 threads)
Morphological filter: 65% (1 threads)
Morphological filter: 66% (1 threads)
Morphological filter: 67% (1 threads)
Morphological filter: 68% (1 threads)
Morphological filter: 69% (1 threads)
Morphological filter: 70% (1 threads)
Morphological filter: 71% (1 threads)
Morphological filter: 72% (1 threads)
Morphological filter: 73% (1 threads)
Morphological filter: 74% (1 threads)
Morphological filter: 75% (1 threads)
Morphological filter: 76% (1 threads)
Morphological filter: 77% (1 threads)
Morphological filter: 78% (1 threads)
Morphological filter: 79% (1 threads)
Morphological filter: 80% (1 threads)
Morphological filter: 81% (1 threads)
Morphological filter: 82% (1 threads)
Morphological filter: 83% (1 threads)
Morphological filter: 84% (1 threads)
Morphological filter: 85% (1 threads)
Morphological filter: 86% (1 threads)
Morphological filter: 87% (1 threads)
Morphological filter: 88% (1 threads)
Morphological filter: 89% (1 threads)
Morphological filter: 90% (1 threads)
Morphological filter: 91% (1 threads)
Morphological filter: 92% (1 threads)
Morphological filter: 93% (1 threads)
Morphological filter: 94% (1 threads)
Morphological filter: 95% (1 threads)
Morphological filter: 96% (1 threads)
Morphological filter: 97% (1 threads)
Morphological filter: 98% (1 threads)
Morphological filter: 99% (1 threads)
Morphological filter: 3% (1 threads)
Morphological filter: 4% (1 threads)
Morphological filter: 5% (1 threads)
Morphological filter: 6% (1 threads)
Morphological filter: 7% (1 threads)
Morphological filter: 8% (1 threads)
Morphological filter: 9% (1 threads)
Morphological filter: 10% (1 threads)
Morphological filter: 11% (1 threads)
Morphological filter: 12% (1 threads)
Morphological filter: 13% (1 threads)
Morphological filter: 14% (1 threads)
Morphological filter: 15% (1 threads)
Morphological filter: 16% (1 threads)
Morphological filter: 17% (1 threads)
Morphological filter: 18% (1 threads)
Morphological filter: 19% (1 threads)
Morphological filter: 20% (1 threads)
Morphological filter: 21% (1 threads)
Morphological filter: 22% (1 threads)
Morphological filter: 23% (1 threads)
Morphological filter: 24% (1 threads)
Morphological filter: 25% (1 threads)
Morphological filter: 26% (1 threads)
Morphological filter: 27% (1 threads)
Morphological filter: 28% (1 threads)
Morphological filter: 29% (1 threads)
Morphological filter: 30% (1 threads)
Morphological filter: 31% (1 threads)
Morphological filter: 32% (1 threads)
Morphological filter: 33% (1 threads)
Morphological filter: 34% (1 threads)
Morphological filter: 35% (1 threads)
Morphological filter: 36% (1 threads)
Morphological filter: 37% (1 threads)
Morphological filter: 38% (1 threads)
Morphological filter: 39% (1 threads)
Morphological filter: 40% (1 threads)
Morphological filter: 41% (1 threads)
Morphological filter: 42% (1 threads)
Morphological filter: 43% (1 threads)
Morphological filter: 44% (1 threads)
Morphological filter: 45% (1 threads)
Morphological filter: 46% (1 threads)
Morphological filter: 47% (1 threads)
Morphological filter: 48% (1 threads)
Morphological filter: 49% (1 threads)
Morphological filter: 50% (1 threads)
Morphological filter: 51% (1 threads)
Morphological filter: 52% (1 threads)
Morphological filter: 53% (1 threads)
Morphological filter: 54% (1 threads)
Morphological filter: 55% (1 threads)
Morphological filter: 56% (1 threads)
Morphological filter: 57% (1 threads)
Morphological filter: 58% (1 threads)
Morphological filter: 59% (1 threads)
Morphological filter: 60% (1 threads)
Morphological filter: 61% (1 threads)
Morphological filter: 62% (1 threads)
Morphological filter: 63% (1 threads)
Morphological filter: 64% (1 threads)
Morphological filter: 65% (1 threads)
Morphological filter: 66% (1 threads)
Morphological filter: 67% (1 threads)
Morphological filter: 68% (1 threads)
Morphological filter: 69% (1 threads)
Morphological filter: 70% (1 threads)
Morphological filter: 71% (1 threads)
Morphological filter: 72% (1 threads)
Morphological filter: 73% (1 threads)
Morphological filter: 74% (1 threads)
Morphological filter: 75% (1 threads)
Morphological filter: 76% (1 threads)
Morphological filter: 77% (1 threads)
Morphological filter: 78% (1 threads)
Morphological filter: 79% (1 threads)
Morphological filter: 80% (1 threads)
Morphological filter: 81% (1 threads)
Morphological filter: 82% (1 threads)
Morphological filter: 83% (1 threads)
Morphological filter: 84% (1 threads)
Morphological filter: 85% (1 threads)
Morphological filter: 86% (1 threads)
Morphological filter: 87% (1 threads)
Morphological filter: 88% (1 threads)
Morphological filter: 89% (1 threads)
Morphological filter: 90% (1 threads)
Morphological filter: 91% (1 threads)
Morphological filter: 92% (1 threads)
Morphological filter: 93% (1 threads)
Morphological filter: 94% (1 threads)
Morphological filter: 95% (1 threads)
Morphological filter: 96% (1 threads)
Morphological filter: 97% (1 threads)
Morphological filter: 98% (1 threads)
Morphological filter: 99% (1 threads)
Morphological filter: 2% (1 threads)
Morphological filter: 3% (1 threads)
Morphological filter: 4% (1 threads)
Morphological filter: 5% (1 threads)
Morphological filter: 6% (1 threads)
Morphological filter: 7% (1 threads)
Morphological filter: 8% (1 threads)
Morphological filter: 9% (1 threads)
Morphological filter: 10% (1 threads)
Morphological filter: 11% (1 threads)
Morphological filter: 12% (1 threads)
Morphological filter: 13% (1 threads)
Morphological filter: 14% (1 threads)
Morphological filter: 15% (1 threads)
Morphological filter: 16% (1 threads)
Morphological filter: 17% (1 threads)
Morphological filter: 18% (1 threads)
Morphological filter: 19% (1 threads)
Morphological filter: 20% (1 threads)
Morphological filter: 21% (1 threads)
Morphological filter: 22% (1 threads)
Morphological filter: 23% (1 threads)
Morphological filter: 24% (1 threads)
Morphological filter: 25% (1 threads)
Morphological filter: 26% (1 threads)
Morphological filter: 27% (1 threads)
Morphological filter: 28% (1 threads)
Morphological filter: 29% (1 threads)
Morphological filter: 30% (1 threads)
Morphological filter: 31% (1 threads)
Morphological filter: 32% (1 threads)
Morphological filter: 33% (1 threads)
Morphological filter: 34% (1 threads)
Morphological filter: 35% (1 threads)
Morphological filter: 36% (1 threads)
Morphological filter: 37% (1 threads)
Morphological filter: 38% (1 threads)
Morphological filter: 39% (1 threads)
Morphological filter: 40% (1 threads)
Morphological filter: 41% (1 threads)
Morphological filter: 42% (1 threads)
Morphological filter: 43% (1 threads)
Morphological filter: 44% (1 threads)
Morphological filter: 45% (1 threads)
Morphological filter: 46% (1 threads)
Morphological filter: 47% (1 threads)
Morphological filter: 48% (1 threads)
Morphological filter: 49% (1 threads)
Morphological filter: 50% (1 threads)
Morphological filter: 51% (1 threads)
Morphological filter: 52% (1 threads)
Morphological filter: 53% (1 threads)
Morphological filter: 54% (1 threads)
Morphological filter: 55% (1 threads)
Morphological filter: 56% (1 threads)
Morphological filter: 57% (1 threads)
Morphological filter: 58% (1 threads)
Morphological filter: 59% (1 threads)
Morphological filter: 60% (1 threads)
Morphological filter: 61% (1 threads)
Morphological filter: 62% (1 threads)
Morphological filter: 63% (1 threads)
Morphological filter: 64% (1 threads)
Morphological filter: 65% (1 threads)
Morphological filter: 66% (1 threads)
Morphological filter: 67% (1 threads)
Morphological filter: 68% (1 threads)
Morphological filter: 69% (1 threads)
Morphological filter: 70% (1 threads)
Morphological filter: 71% (1 threads)
Morphological filter: 72% (1 threads)
Morphological filter: 73% (1 threads)
Morphological filter: 74% (1 threads)
Morphological filter: 75% (1 threads)
Morphological filter: 76% (1 threads)
Morphological filter: 77% (1 threads)
Morphological filter: 78% (1 threads)
Morphological filter: 79% (1 threads)
Morphological filter: 80% (1 threads)
Morphological filter: 81% (1 threads)
Morphological filter: 82% (1 threads)
Morphological filter: 83% (1 threads)
Morphological filter: 84% (1 threads)
Morphological filter: 85% (1 threads)
Morphological filter: 86% (1 threads)
Morphological filter: 87% (1 threads)
Morphological filter: 88% (1 threads)
Morphological filter: 89% (1 threads)
Morphological filter: 90% (1 threads)
Morphological filter: 91% (1 threads)
Morphological filter: 92% (1 threads)
Morphological filter: 93% (1 threads)
Morphological filter: 94% (1 threads)
Morphological filter: 95% (1 threads)
Morphological filter: 96% (1 threads)
Morphological filter: 97% (1 threads)
Morphological filter: 98% (1 threads)
Morphological filter: 99% (1 threads)
Morphological filter: 1% (1 threads)
Morphological filter: 2% (1 threads)
Morphological filter: 3% (1 threads)
Morphological filter: 4% (1 threads)
Morphological filter: 5% (1 threads)
Morphological filter: 6% (1 threads)
Morphological filter: 7% (1 threads)
Morphological filter: 8% (1 threads)
Morphological filter: 9% (1 threads)
Morphological filter: 10% (1 threads)
Morphological filter: 11% (1 threads)
Morphological filter: 12% (1 threads)
Morphological filter: 13% (1 threads)
Morphological filter: 14% (1 threads)
Morphological filter: 15% (1 threads)
Morphological filter: 16% (1 threads)
Morphological filter: 17% (1 threads)
Morphological filter: 18% (1 threads)
Morphological filter: 19% (1 threads)
Morphological filter: 20% (1 threads)
Morphological filter: 21% (1 threads)
Morphological filter: 22% (1 threads)
Morphological filter: 23% (1 threads)
Morphological filter: 24% (1 threads)
Morphological filter: 25% (1 threads)
Morphological filter: 26% (1 threads)
Morphological filter: 27% (1 threads)
Morphological filter: 28% (1 threads)
Morphological filter: 29% (1 threads)
Morphological filter: 30% (1 threads)
Morphological filter: 31% (1 threads)
Morphological filter: 32% (1 threads)
Morphological filter: 33% (1 threads)
Morphological filter: 34% (1 threads)
Morphological filter: 35% (1 threads)
Morphological filter: 36% (1 threads)
Morphological filter: 37% (1 threads)
Morphological filter: 38% (1 threads)
Morphological filter: 39% (1 threads)
Morphological filter: 40% (1 threads)
Morphological filter: 41% (1 threads)
Morphological filter: 42% (1 threads)
Morphological filter: 43% (1 threads)
Morphological filter: 44% (1 threads)
Morphological filter: 45% (1 threads)
Morphological filter: 46% (1 threads)
Morphological filter: 47% (1 threads)
Morphological filter: 48% (1 threads)
Morphological filter: 49% (1 threads)
Morphological filter: 50% (1 threads)
Morphological filter: 51% (1 threads)
Morphological filter: 52% (1 threads)
Morphological filter: 53% (1 threads)
Morphological filter: 54% (1 threads)
Morphological filter: 55% (1 threads)
Morphological filter: 56% (1 threads)
Morphological filter: 57% (1 threads)
Morphological filter: 58% (1 threads)
Morphological filter: 59% (1 threads)
Morphological filter: 60% (1 threads)
Morphological filter: 61% (1 threads)
Morphological filter: 62% (1 threads)
Morphological filter: 63% (1 threads)
Morphological filter: 64% (1 threads)
Morphological filter: 65% (1 threads)
Morphological filter: 66% (1 threads)
Morphological filter: 67% (1 threads)
Morphological filter: 68% (1 threads)
Morphological filter: 69% (1 threads)
Morphological filter: 70% (1 threads)
Morphological filter: 71% (1 threads)
Morphological filter: 72% (1 threads)
Morphological filter: 73% (1 threads)
Morphological filter: 74% (1 threads)
Morphological filter: 75% (1 threads)
Morphological filter: 76% (1 threads)
Morphological filter: 77% (1 threads)
Morphological filter: 78% (1 threads)
Morphological filter: 79% (1 threads)
Morphological filter: 80% (1 threads)
Morphological filter: 81% (1 threads)
Morphological filter: 82% (1 threads)
Morphological filter: 83% (1 threads)
Morphological filter: 84% (1 threads)
Morphological filter: 85% (1 threads)
Morphological filter: 86% (1 threads)
Morphological filter: 87% (1 threads)
Morphological filter: 88% (1 threads)
Morphological filter: 89% (1 threads)
Morphological filter: 90% (1 threads)
Morphological filter: 91% (1 threads)
Morphological filter: 92% (1 threads)
Morphological filter: 93% (1 threads)
Morphological filter: 94% (1 threads)
Morphological filter: 95% (1 threads)
Morphological filter: 96% (1 threads)
Morphological filter: 97% (1 threads)
Morphological filter: 98% (1 threads)
Morphological filter: 99% (1 threads)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#las &lt;- classify_ground(las, algorithm = pmf())</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># this is 3d so wont render on datalabs</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#plot(las, color = "Classification", size = 3, bg = "white") </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># can subset out the ground just to look at that:</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>gnd <span class="ot">&lt;-</span> <span class="fu">filter_ground</span>(las)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># this plots the point cloud of the ground</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gnd, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">bng=</span> <span class="st">"white"</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="do">### cloth fold simulation method of ground classification: </span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RCSF)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>mycsf <span class="ot">&lt;-</span> <span class="fu">csf</span>(<span class="at">sloop_smooth =</span> <span class="cn">FALSE</span>, <span class="at">rigidness =</span> <span class="dv">2</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>las <span class="ot">&lt;-</span> <span class="fu">classify_ground</span>(las, mycsf)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">#plot_crossection(las, colour_by = factor(Classification))</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co"># plotting cross sections of the ground</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co">#las_f &lt;- las</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co">#las_f@data$Classification &lt;- as.factor(las_f@data$Classification)</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="co">#levels(las_f@data$Classification) &lt;- c("ground", "low veg", "med veg", "high veg",</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="co">#                                     "building", "noise", "10","13", "14" ,</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co">#                                     "15", "18", "22" )</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>v_n <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.95</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(v_n)){</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> v_n[i]</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">min</span>(las<span class="sc">@</span>data<span class="sc">$</span>X), <span class="fu">quantile</span>(las<span class="sc">@</span>data<span class="sc">$</span>Y, n))</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">max</span>(las<span class="sc">@</span>data<span class="sc">$</span>X), <span class="fu">quantile</span>(las<span class="sc">@</span>data<span class="sc">$</span>Y,n))</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  data_clip <span class="ot">&lt;-</span> <span class="fu">clip_transect</span>(las, p1, p2, <span class="dv">4</span>)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data_clip<span class="sc">@</span>data, <span class="fu">aes</span>(X,Z, <span class="at">colour=</span> <span class="fu">factor</span>(Classification))) <span class="sc">+</span> </span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#coord_equal() + </span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title.x=</span><span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_brewer</span>(<span class="at">palette=</span> <span class="st">"Paired"</span>)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assign</span>(<span class="fu">paste0</span>(<span class="st">"g_"</span>, n), g)</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(g_0<span class="fl">.1</span>, g_0<span class="fl">.2</span>, g_0<span class="fl">.3</span>, g_0<span class="fl">.4</span>, g_0<span class="fl">.5</span>,</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>          g_0<span class="fl">.6</span>, g_0<span class="fl">.7</span>, g_0<span class="fl">.8</span>, g_0<span class="fl">.9</span>,</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>          <span class="at">ncol =</span> <span class="dv">1</span>, </span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">common.legend =</span> T, </span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a><span class="co"># can also use the cloth simulation to select the ground</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a><span class="co"># or multiscale curvature classification</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="the-digital-terrain-model" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="the-digital-terrain-model"><span class="header-section-number">3.2</span> The digital terrain model:</h2>
<p>DTM is the image of the ground do this after you have classified the ground</p>
<p>have different methods like invert distance weighting, kriging triangular irregular network</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>dtm_tin <span class="ot">&lt;-</span> <span class="fu">rasterize_terrain</span>(las, <span class="at">res =</span> <span class="dv">2</span>, <span class="at">algorithm =</span> <span class="fu">tin</span>())</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dtm_tin)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="cn">FALSE</span>){</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_dtm3d</span>(dtm_tin, <span class="at">bg =</span> <span class="st">"white"</span>) </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># duifferent ways of producing digital terrain model</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">#dtm &lt;- rasterize_terrain(las, algorithm = tin(), pkg ="terra")</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="cn">FALSE</span>){</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_dtm3d</span>(dtm, <span class="at">bg =</span> <span class="st">"white"</span>) </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">#dtm_prod &lt;- terrain(dtm, v = c("slope", "aspect"), unit = "radians")</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">#dtm_hillshade &lt;- shade(slope = dtm_prod$slope, aspect = dtm_prod$aspect)</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="cn">FALSE</span>){</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dtm_hillshade, <span class="at">col =</span><span class="fu">gray</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">30</span><span class="sc">/</span><span class="dv">30</span>), <span class="at">legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="cn">FALSE</span>){</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>dtm <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">raster</span>(dtm_tin)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>elmat <span class="ot">&lt;-</span> <span class="fu">raster_to_matrix</span>(dtm)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> elmat <span class="sc">%&gt;%</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sphere_shade</span>(<span class="at">texture =</span> <span class="st">"imhof1"</span>, <span class="at">progbar =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_water</span>(<span class="fu">detect_water</span>(elmat), <span class="at">color =</span> <span class="st">"imhof1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_shadow</span>(<span class="fu">ray_shade</span>(elmat, <span class="at">progbar =</span> <span class="cn">FALSE</span>), <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_shadow</span>(<span class="fu">ambient_shade</span>(elmat, <span class="at">progbar =</span> <span class="cn">FALSE</span>), <span class="dv">0</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_map</span>(map)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="do">### can then normalise the height based on the dtm:</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>nlas <span class="ot">&lt;-</span> <span class="fu">normalize_height</span>(las, <span class="fu">knnidw</span>())</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nlas, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a><span class="co"># here I've just manually removed Z values &lt; 0 which is not good:</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># its a sign that the dtm has incorrectly classified the ground</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># at several points: but there were only like 3 isolated points so </span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for now I think this is fine.</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  nlas <span class="ot">&lt;-</span> nlas[nlas<span class="sc">@</span>data<span class="sc">$</span>Z <span class="sc">&gt;</span><span class="dv">0</span>,]</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(nlas, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hist</span>(<span class="fu">filter_ground</span>(nlas)<span class="sc">$</span>Z,   <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.6</span>, <span class="fl">0.6</span>, <span class="fl">0.01</span>), <span class="at">main =</span> <span class="st">""</span>, <span class="at">xlab =</span> <span class="st">"Elevation"</span>)</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="classification-term" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="classification-term"><span class="header-section-number">3.3</span> Classification term</h2>
<p>classification listed as numbers 2,3,4,5,6,10,13,15,18,22 table(las@data$Classification)</p>
<p>chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/http://www.asprs.org/wp-content/uploads/2019/07/LAS_1_4_r15.pdf</p>
<p>ASPRS specification of standard point classes: 0 = Created, never classified 1 = unclassified 2 = ground 3 = low vegetation 4 = medium vegetation 5 = high vegetation 6 = building 7 = low point (noise) 8 = model key point (mass point) 9 = water 10, 11 = reserved for ASPRS definition 12 = overlap points 13 - 31 = reserved for ASPRS definition</p>
<p>Can change classification based on rules:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Classifies the points that are NOT in the lake and that are NOT ground points as class 5</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="do">################</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#plot(las, color = "Classification")</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>nonveg <span class="ot">&lt;-</span> <span class="fu">filter_poi</span>(las, Classification <span class="sc">!=</span> LASHIGHVEGETATION)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>veg <span class="ot">&lt;-</span> <span class="fu">filter_poi</span>(las, Classification <span class="sc">==</span> LASHIGHVEGETATION)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(las, <span class="at">color =</span> <span class="st">"Classification"</span>, <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="dv">3</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="do">## cross section 2d rendering:</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(las)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="do">## function:</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>plot_crossection <span class="ot">&lt;-</span> <span class="cf">function</span>(las,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>                             <span class="at">p1 =</span> <span class="fu">c</span>(<span class="fu">min</span>(las<span class="sc">@</span>data<span class="sc">$</span>X), <span class="fu">mean</span>(las<span class="sc">@</span>data<span class="sc">$</span>Y)),</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>                             <span class="at">p2 =</span> <span class="fu">c</span>(<span class="fu">max</span>(las<span class="sc">@</span>data<span class="sc">$</span>X), <span class="fu">mean</span>(las<span class="sc">@</span>data<span class="sc">$</span>Y)),</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>                             <span class="at">width =</span> <span class="dv">4</span>, <span class="at">colour_by =</span> <span class="cn">NULL</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  colour_by <span class="ot">&lt;-</span> <span class="fu">enquo</span>(colour_by)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  data_clip <span class="ot">&lt;-</span> <span class="fu">clip_transect</span>(las, p1, p2, width)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data_clip<span class="sc">@</span>data, <span class="fu">aes</span>(X,Z)) <span class="sc">+</span> </span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_equal</span>() <span class="sc">+</span> </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(colour_by))</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">color =</span> <span class="sc">!!</span>colour_by) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_crossection</span>(las)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="digital-surface-model-and-canopy-height-model" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="digital-surface-model-and-canopy-height-model"><span class="header-section-number">3.4</span> DIGITAL SURFACE MODEL and canopy height model:</h2>
<p>raster layer that report the highest elevation for the ALS returns</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Can specify the thr and the edg</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Can specify point to raster based or triangulation based</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Includes the Khosravirpour et al pitfree algorithm</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>chm <span class="ot">&lt;-</span> <span class="fu">rasterize_canopy</span>(las, <span class="at">res =</span> <span class="dv">2</span>, <span class="at">algorithm =</span> <span class="fu">p2r</span>())</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>col <span class="ot">&lt;-</span> <span class="fu">height.colors</span>(<span class="dv">25</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chm, <span class="at">col =</span> col)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># can decrease the resolution to cover the empty areas</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># can add a circle of known radius that simulates that the laser is not a point</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># but a circle</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co"># can also fill in the unfilled areas by kriging</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co"># this is more time consuming</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co"># but it also looks a LOT BETTER</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>chm <span class="ot">&lt;-</span> <span class="fu">rasterize_canopy</span>(las, <span class="at">res =</span> <span class="fl">0.5</span>, <span class="fu">p2r</span>(<span class="fl">0.2</span>, <span class="at">na.fill =</span> <span class="fu">tin</span>()))</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chm, <span class="at">col =</span> col)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">#png("outputs/chm_11_01.png", width = 15, height = 15, units = "cm", res = 600)</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">#plot(chm, col= col)</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co">#dev.off()</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co">#plot(chm, color = "Intensity", bg = "white", legend = TRUE)</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co"># overlays: need a dtm for this to work</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co"># think this is a pop out</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">plot</span>(las, <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="dv">3</span>)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="fu">add_dtm3d</span>(x, chm)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="co"># lidR does not include tools to fill empty pixels but terra does:</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="cn">FALSE</span>){</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>  fill.na <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">i=</span><span class="dv">5</span>) { </span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(x)[i]) { <span class="fu">return</span>(<span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) } <span class="cf">else</span> { <span class="fu">return</span>(x[i]) }}</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>  chm <span class="ot">&lt;-</span> <span class="fu">rasterize_canopy</span>(las, <span class="at">res =</span> <span class="fl">0.5</span>, </span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>                          <span class="at">algorithm =</span> <span class="fu">p2r</span>(<span class="at">subcircle =</span> <span class="fl">0.25</span>), <span class="at">pkg =</span> <span class="st">"terra"</span>)</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>  filled <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">focal</span>(chm, w, <span class="at">fun =</span> fill.na)</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  smoothed <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">focal</span>(chm, w, <span class="at">fun =</span> mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>  chms <span class="ot">&lt;-</span> <span class="fu">c</span>(chm, filled, smoothed)</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(chms) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Base"</span>, <span class="st">"Filled"</span>, <span class="st">"Smoothed"</span>)</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(chms, <span class="at">col =</span> col)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="locating-trees" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="locating-trees"><span class="header-section-number">3.5</span> Locating trees:</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lmf(ws, hmin = 2, shape = c("circular", "square"), ws_args = "Z")</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ws:    numeric or function. Length or diameter of the moving window </span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># used to detect the local maxima in the units of the input data </span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># (usually meters). If it is numeric a fixed window size is used. </span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># If it is a function, the function determines the size of the window </span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># at any given location on the canopy. By default function takes the </span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># height of a given pixel or point as its only argument and return the</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># desired size of the search window when centered on that pixel/point. </span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># This can be controled with the 'ws_args' parameter.</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># hmin: numeric. Minimum height of a tree. Threshold below which a </span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># pixel or a point cannot be a local maxima. Default is 2.</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># shape: character. Shape of the moving window used to find the local </span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># maxima. Can be "square" or "circular".</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ws_args: list. Named list of argument for the function 'ws' if 'ws'</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co"># is a function.</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>ttops <span class="ot">&lt;-</span> <span class="fu">locate_trees</span>(las, <span class="fu">lmf</span>(<span class="at">ws =</span> <span class="dv">20</span>)) </span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chm, <span class="at">col =</span> <span class="fu">height.colors</span>(<span class="dv">50</span>))</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sf<span class="sc">::</span><span class="fu">st_geometry</span>(ttops), <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">pch =</span> <span class="dv">3</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co">#png("outputs/ttops_11_01_ws20.png", width = 15, height = 15, units = "cm", res #= 600)</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co">#plot(chm, col = height.colors(50))</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co">#plot(sf::st_geometry(ttops), add = TRUE, pch = 3)</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co">#dev.off()</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the point cloud</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="co"># It's somehow added on a tree that's 60m tall in the middle of the plot</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="co"># that has no data to support it</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>offsets <span class="ot">&lt;-</span> <span class="fu">plot</span>(las, <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="dv">3</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="fu">add_treetops3d</span>(offsets, ttops)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="co"># num,ber of trees detected is related to the ws value:</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>ttops_3m <span class="ot">&lt;-</span> <span class="fu">locate_trees</span>(las, <span class="fu">lmf</span>(<span class="at">ws =</span> <span class="dv">3</span>))</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>ttops_11m <span class="ot">&lt;-</span> <span class="fu">locate_trees</span>(las, <span class="fu">lmf</span>(<span class="at">ws =</span> <span class="dv">11</span>))</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chm, <span class="at">col =</span> <span class="fu">height.colors</span>(<span class="dv">50</span>))</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sf<span class="sc">::</span><span class="fu">st_geometry</span>(ttops_3m), <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">pch =</span> <span class="dv">3</span>)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chm, <span class="at">col =</span> <span class="fu">height.colors</span>(<span class="dv">50</span>))</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sf<span class="sc">::</span><span class="fu">st_geometry</span>(ttops_11m), <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">pch =</span> <span class="dv">3</span>)</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the coordinates of the trees and apply the shift to display the lines</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a><span class="co"># in the rendering coordinate system</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(ttops)[,<span class="dv">1</span>] <span class="sc">-</span> offsets[<span class="dv">1</span>] </span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(ttops)[,<span class="dv">2</span>] <span class="sc">-</span> offsets[<span class="dv">2</span>] </span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> ttops<span class="sc">$</span>Z</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a GL_LINES matrix for fast rendering</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(x, <span class="at">each =</span> <span class="dv">2</span>)</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rep</span>(y, <span class="at">each =</span> <span class="dv">2</span>)</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">2</span><span class="sc">*</span><span class="fu">length</span>(z)) </span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>tmp[<span class="dv">2</span><span class="sc">*</span><span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(z)] <span class="ot">&lt;-</span> z</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> tmp</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">cbind</span>(x,y,z)</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Display lines</span></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>rgl<span class="sc">::</span><span class="fu">segments3d</span>(M, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a><span class="co"># individual segmentation:</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>algo <span class="ot">&lt;-</span> <span class="fu">dalponte2016</span>(chm, ttops)</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">segment_trees</span>(las, algo) <span class="co"># segment point cloud</span></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(t, <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"treeID"</span>) <span class="co"># visualize trees</span></span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a><span class="co"># dont feel that confident about this1</span></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a><span class="co"># extrtact crowns:</span></span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>crowns <span class="ot">&lt;-</span> <span class="fu">crown_metrics</span>(t, <span class="at">func =</span> .stdtreemetrics, <span class="at">geom =</span> <span class="st">"convex"</span>)</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(crowns[<span class="st">"convhull_area"</span>], <span class="at">main =</span> <span class="st">"Crown area (convex hull)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./gedi_exploration.html" class="pagination-link" aria-label="GEDI data exploration">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">GEDI data exploration</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./sentinel1.html" class="pagination-link" aria-label="Sentinel 1 SAR time-lapse image">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Sentinel 1 SAR time-lapse image</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>